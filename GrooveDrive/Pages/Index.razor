@page "/"

@using Microsoft.AspNetCore.Authorization
@using Microsoft.Graph

@attribute [Authorize]
@inject PlayerState _playerState

<PageTitle>
    @if (_playerState.CurrentSong is not null)
    {
        <text>@GetTitle(_playerState.CurrentSong) von @(_playerState.CurrentSong.Audio?.Artist)</text>
    }
    else
    {
        @pageTitle
    }
</PageTitle>

@if (_playerState.IsLoading)
{
    <Spinner />
}
else
{
    <SongsContainer>
        @foreach (var item in _playerState.AllMusic)
        {
            <SongListItem Title="@GetTitle(item)" Text="@($"{item.Audio?.Album}\n{item.Audio?.Artist}")" DriveItem="item" ClickHandler="@(() => _playerState.Play(item))" />
        }
    </SongsContainer>
}

@code {
    private bool isLoading => _playerState.IsLoading;
    private string pageTitle => $"Groove Drive{(isLoading ? " is loading..." : "")}";
    private string GetTitle(DriveItem item) => item is null ? "" : item.Audio is null ? item.Name : item.Audio.Title;
    
    protected override void OnInitialized()
    {
        _playerState.OnChange += StateHasChanged;
    }
}
